# Docker on Travis requires sudo.
sudo: required

install:
  - sudo pip install -r requirements.txt

script:
  - source define_repo.sh
  - sudo ./build_run_test.sh

after_success:
  - IMAGE=`sudo docker ps --latest --format '{{ .Image }}'` # TODO: with more containers, can't rely on ordering
  - tag_push() { echo "Tagging into $2"; sudo docker tag $1 $2; sudo docker push $2; }

  - sudo docker login -u mccalluc -p $DOCKER_PASS
  # Always update "latest": the cache will be used for the next build.
  - tag_push $IMAGE $REPO
  - >
      if [ "$TRAVIS_EVENT_TYPE" == "pull_request" ]; then
        echo "PR!";

        BRANCH=`echo ${TRAVIS_PULL_REQUEST_BRANCH:-$TRAVIS_BRANCH} | perl -pne 'chomp;s{.*/}{};s/\W/-/g'`;
        tag_push $IMAGE $REPO:$BRANCH;
        tag_push $IMAGE $REPO:latest-pr;
      fi
  - >
      if [ ! -z "$TRAVIS_TAG" ]; then
        echo "Git tag!";
        tag_push $IMAGE $REPO:$TRAVIS_TAG;
        tag_push $IMAGE $REPO:latest;
      fi

secure: "h1z53lEbtyeEkmSrpQpEIaCAAfb7Z3R5s1IpHj+o4P0cAXZuLsfvuwSv5Zw3UXXGE3NnquyXgrK/gUvfeuyuYolmsla1NHdzJM5LqGjOI/f0c06XvmMidcfqRC25Uh3QgU+5/Xr0q4tep5B4wLtBgFMW1e3DT2qy2Uj2wSXis/+TyRIa45YEj4iHKhOOlasd18ChyDiShLMK8G0MnhRq3R7OYVpvYLsFAk4UPS4uOUi5wW/aGLx/wpfDdbPtkZ5vSYN+LE6AbRXMsxJPxz/D07eYDVgp4xRcrVCY4Lw4g/0NZRGQTlq56HbfGlW8LwE+NiysIbgsEKJjPbpYYMpz13Pi3M0lfBjdQ7ZBFTMhl6w4EZhciyxOcuY2OO0hB0k8Xdi00PrddYN7jZ3IalSc+n0PdzVw+WIQsr/m6MtqzFT8/wv8CaMm0e6+4wemXLMQBOJgzui0Dto63tnDVTJY35yOZUsWV/1hYQmVA4gaV/d4Z8nl1DtUkOlPXjOOd3Mn5D0on0R8jotuqYANcMvzQPSdWDOxzSF3e63AWiVnLETunt7MsKNoAgDh0wy+VsU7350kYaNfQp/Ui0S1T9H1n3mfBGbSN8q0fSUiQd4lRmfjjimkRI+Jf81FkplDa0sg8ORPaxfNIsAznanrcu/dI42UfQ9xh0+lr0p9rR1mPTg="
